BX.namespace("Tasks.Component");(function(){var t=function(t,e){this.data=t.data;if(typeof t.can!="undefined"&&typeof t.can.ACTION!="undefined"){this.can=t.can.ACTION}else{this.can={}}var i=this.data.IS_COMPLETE=="Y";if(typeof this.can.REMOVE=="undefined"){this.can.REMOVE=true}if(typeof this.can.MODIFY=="undefined"){this.can.MODIFY=true}this.data.CHECKED=i?"checked":"";this.data.REMOVE_HIDDEN=this.can.REMOVE?"":" hidden";this.data.MODIFY_HIDDEN=this.can.MODIFY?"":" hidden";this.scope=e.getNodeByTemplate("item",this.data)[0];this.mode="read";this.ctrls={btnEdit:e.control("item-btn-edit",this.scope),btnDelete:e.control("item-btn-delete",this.scope),btnApply:e.control("item-btn-apply",this.scope),btnCheck:e.control("item-btn-check",this.scope),titleEdit:e.control("item-title-edit",this.scope),title:e.control("item-title",this.scope),sortIndexFld:e.control("item-sort-index-fld",this.scope),isCompleteFld:e.control("item-is-complete-fld",this.scope)};BX.data(this.scope,"item-id",this.id());for(var s in this.ctrls){BX.data(this.ctrls[s],"item-id",this.id())}this.parent=e};BX.merge(t.prototype,{isComplete:function(t){if(typeof t!=="undefined"){this.data.IS_COMPLETE=t?"Y":"N";this.redraw();return}return this.data.IS_COMPLETE=="Y"},sortIndex:function(t){if(typeof t!=="undefined"){this.data.SORT_INDEX=parseInt(t);this.redraw();return}return parseInt(this.data.SORT_INDEX)},id:function(){return this.data.ID},title:function(t){if(typeof t!="undefined"){this.data.TITLE=t;this.redraw();return}return this.data.TITLE},destruct:function(){BX.remove(this.scope);this.scope=null;this.ctrls=null;this.data=null},setEditMode:function(){if(this.mode=="edit"){return}this.mode="edit";this.ctrls.titleEdit.value=this.data.TITLE;this.redraw()},setReadMode:function(){if(this.mode=="read"){return}this.mode="read";this.redraw()},applyChanges:function(){var t=this.ctrls.titleEdit.value.toString();if(t.length>0){this.setReadMode();this.title(t)}},handleDelete:function(){if(this.mode=="edit"){this.ctrls.titleEdit.value=this.data.TITLE;this.setReadMode();return false}else{return true}},redraw:function(){if(this.mode=="edit"){this.parent.switchControl(this.scope,"on")}else{this.parent.switchControl(this.scope,"off")}try{this.ctrls.title.innerHTML=BX.util.htmlspecialchars(this.data.TITLE)}catch(t){}try{this.ctrls.btnCheck.checked=this.isComplete()}catch(t){}try{this.ctrls.isCompleteFld.value=this.isComplete()?"Y":"N"}catch(t){}try{this.ctrls.sortIndexFld.value=parseInt(this.sortIndex())}catch(t){}}});BX.Tasks.Component.TaskDetailPartsChecklist=BX.Tasks.UI.Widget.extend({methods:{construct:function(){this.code("checklist");BX.merge(this.vars,{items:{},newIncrement:0});var t=new BX.Tasks.UI.DragAndDrop({createFlying:BX.delegate(function(t){var e=BX.data(t,"item-id");var i=this.vars.items[e];return this.getNodeByTemplate("item-flying",{TITLE:i.title(),CHECKED:i.isComplete()?"checked":"",ID:i.id()})[0]},this)});t.bindDropZone(this.control("items-ongoing"));t.bindDropZone(this.control("items-complete"));this.instances={dragNDrop:t};this.bindEvents()},bindEvents:function(){this.bindDelegateControl("click","item-btn-edit",this.passCtx(this.setItemEdit));this.bindDelegateControl("click","item-btn-delete",this.passCtx(this.setItemCancel));this.bindDelegateControl("click","item-btn-apply",this.passCtx(this.setItemApply));this.bindDelegateControl("change","item-btn-check",this.passCtx(this.setItemToggle));this.bindDelegateControl("keydown","item-title-edit",this.passCtx(this.setItemApplyOnKeydown));this.bindDelegateControl("click","add-item-form-open",this.passCtx(this.newItemOpenForm));this.bindDelegateControl("click","add-item",this.passCtx(this.newItemAdd));this.bindDelegateControl("keydown","add-item-title",this.passCtx(this.newItemTitleKeydown));this.instances.dragNDrop.bindEvent("item-relocated",BX.delegate(this.itemRelocated,this))},itemRelocated:function(t,e,i){var s=BX.data(t,"item-id");var n=this.vars.items[s];var o=e==this.control("items-complete");n.isComplete(o);var r=false;if(i.after!==null){r=BX.data(i.after,"item-id")}if(o&&r===false){r=this.getOngoingItemByGreatestSortIndex()}if(r!=s){this.shiftSortIndexes(s,r)}this.redraw()},shiftSortIndexes:function(t,e){var i=this.getSortedItemList();var s=[];if(e===false){s.push(t)}for(var n=0;n<i.length;n++){if(i[n].id==t){continue}s.push(i[n].id);if(e!==false&&i[n].id==e){s.push(t)}}var o=0;for(var n=0;n<s.length;n++){this.vars.items[s[n]].sortIndex(o);o++}},setItemEdit:function(t){this.switchControl(this.control("add-item-form"),"off");this.doOnItem(t,function(t){t.setEditMode()})},setItemCancel:function(t){this.doOnItem(t,function(t){if(t.handleDelete()){this.deleteItem(t.id())}})},setItemApply:function(t){this.doOnItem(t,function(t){t.applyChanges()})},setItemApplyOnKeydown:function(t,e){if(this.isEnter(e)){this.setItemApply(t);BX.PreventDefault(e)}},setItemToggle:function(t){this.doOnItem(t,function(e){e.isComplete(t.checked)});this.redraw()},doOnItem:function(t,e){var i=BX.data(t,"item-id");if(typeof i!="undefined"&&i!==null){e.apply(this,[this.vars.items[i]])}},addItem:function(e){if(e.data.TITLE.toString().length==0){return}var i=new t(e,this);this.vars.items[i.id()]=i},deleteItem:function(t){if(typeof this.vars.items[t]=="undefined"){return}var e=this.vars.items[t];this.instances.dragNDrop.unBindNode(e.scope);e.destruct();this.vars.items[t]=null;delete this.vars.items[t];this.redraw()},getSortedItemList:function(){var t=[];for(var e in this.vars.items){t.push({ix:this.vars.items[e].sortIndex(),id:this.vars.items[e].id()})}return t.sort(function(t,e){if(t.ix<e.ix){return-1}else if(t.ix>e.ix){return 1}return 0})},redraw:function(){var t=0;var e=0;var i=this.getSortedItemList();var s=BX.create("div");var n=BX.create("div");for(var o=0;o<i.length;o++){e++;if(this.vars.items[i[o].id].isComplete()){t++}var r=this.vars.items[i[o].id];BX.append(r.scope,r.isComplete()?n:s);this.instances.dragNDrop.bindNode(r.scope,{handle:this.control("item-drag",r.scope)})}this.moveNodePool(n,this.control("items-complete"));this.moveNodePool(s,this.control("items-ongoing"));this.showControlIf("complete-block",t>0);try{this.control("ongoing-counter").innerHTML=e-t}catch(a){}try{this.control("complete-counter").innerHTML=t}catch(a){}},moveNodePool:function(t,e){while(t.childNodes.length>0){BX.append(t.childNodes[0],e)}},load:function(t,e){if(BX.type.isPlainObject(t)){for(var i in t){var s={data:BX.clone(t[i]),can:{}};if(typeof e[i]!="undefined"){s.can=BX.clone(e[i])}this.addItem(s)}this.redraw()}},getOngoingItemByGreatestSortIndex:function(){var t=0;var e=false;for(var i in this.vars.items){var s=this.vars.items[i].sortIndex();if(s>t&&!this.vars.items[i].isComplete()){t=s;e=i}}return e},getGreatestSortIndex:function(){var t=0;for(var e in this.vars.items){var i=this.vars.items[e].sortIndex();if(i>t){t=i}}return t},newItemOpenForm:function(){this.switchControl(this.control("add-item-form"),"on");this.control("add-item-title").focus()},newItemTitleKeydown:function(t,e){if(this.isEnter(e)){this.newItemAdd();BX.PreventDefault(e)}},newItemAdd:function(){if(this.control("add-item-title").value.toString().length<1){return}var t={ID:"n"+this.vars.newIncrement++,IS_COMPLETE:"N",SORT_INDEX:this.getGreatestSortIndex()+1,TITLE:this.control("add-item-title").value};this.control("add-item-title").value="";this.control("add-item-title").focus();this.addItem({data:t});this.redraw()},showControlIf:function(t,e){BX[e?"removeClass":"addClass"](this.control(t),"hidden")},switchControl:function(t,e){e=e=="on";if(e){BX.addClass(t,"on");BX.removeClass(t,"off")}else{BX.removeClass(t,"on");BX.addClass(t,"off")}},isEnter:function(t){t=t||window.event;return t.keyCode==13}}})})();
//# sourceMappingURL=logic.map.js